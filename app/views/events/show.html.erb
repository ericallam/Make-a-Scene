<%= content_for(:facebook_js) do %>
  <div id="fb-root"></div>
  <script>
    window.fbAsyncInit = function() {
      FB.init({appId: '125288907521593', status: true, cookie: true, xfbml: true});

      FB.Event.subscribe('auth.sessionChange', function(response) {
        if (response.session) {
          console.log('logged in');
          console.log(response);
          // A user has logged in, and a new cookie has been saved
        } else {
          // The user has logged out, and the cookie has been cleared
          console.log('failed login');
          console.log(response);
        }
      });
      

    };

    (function() {
      var e = document.createElement('script');
      e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
      e.async = true;
      document.getElementById('fb-root').appendChild(e);
    }());

  </script>
<% end %>

<div id="main-image" class="shadow">
  <%= image_tag @event.photos.first.image.url(:big), 'data-photo-id' => @event.photos.first.id %>
  <div id='action_buttons'>
    <%= link_to 'fb', '#', :id => 'facebook_link' %>
    <% if @photo_shares && share = @photo_shares.detect {|ps| ps.photo == @event.photos.first } %>
      <%= link_to 'View on Facebook', share.facebook_photo_url, :target => '_blank' %>
    <% end %>
  </div>
</div>

<ul class="thumbs four_column">
  <% @event.photos.each do |photo| %>
    <li><%= link_to image_tag(photo.image.url(:small), :class => 'shadow'), '#', :class => 'image_link', 'data-image-url' => photo.image.url(:big), 'data-photo-id' => photo.id %></li>
    <%= image_tag photo.image.url(:big), :style => 'display:none', :id => "photo_big_#{photo.id}", 'data-photo-id' => photo.id %>
  <% end %>
</ul>
<div class="clear"></div>

<script>

  var lastRequestData;

  var imageSizes;
    
  var postPhotoToFacebook = function(){
    var photo_id = $("#main-image img:first").attr('data-photo-id');
    $.post('<%= post_photo_to_facebook_event_url(@event) %>', {'photo_id': photo_id}, function(data){
      lastRequestData = data;
      console.log('posted photo with data ' + data);
      if(lastRequestData['link'] !== '' && lastRequestData['link'] !== null){
        if($('#view_on_facebook').length === 0){
          var link_to_photo = $('<a target="_blank">View on Facebook</a>').attr('href', lastRequestData['link']).attr('id', 'view_on_facebook');
          $('#action_buttons').append(link_to_photo);
        }else{
          $('#view_on_facebook').attr('href', lastRequestData['link']);
        }
      }
    });
  }

  var resizeThumbsForWidth = function(width){
  
    if(width <= 368){
      $('ul.thumbs').removeClass('two_column three_column').addClass('four_column');
    }else if(width <= 498){
      $('ul.thumbs').removeClass('two_column four_column').addClass('three_column');
    }else {
      $('ul.thumbs').removeClass('three_column four_column').addClass('two_column');
    }
  }

  $(document).ready(function(){

    $('#main-image img:first').load(function(e){
      resizeThumbsForWidth(this.width);
    })

    $('.image_link').click(function(e){
      e.preventDefault(); 
      var link = $(this);
      var image_url = link.attr('data-image-url');
      var photo_id = link.attr('data-photo-id');
      

      var image_container = $('#main-image');
      var current_big_image = image_container.find('img:first');

      if(current_big_image.attr('data-photo-id') !== photo_id){
        var image = $('#photo_big_' + photo_id);
        var image_width = image[0].width
        image.detach();

        image_container.find('img').fadeOut('fast', function(){
          var old_image = $(this);
          old_image.detach().hide();
          $('#land_of_used_images').prepend(old_image);
          image_container.prepend(image);
          image.fadeIn('fast')
        });

        if($('#view_on_facebook').length === 1){
          $('#view_on_facebook').remove();
        }

        resizeThumbsForWidth(image_width);
      }


    })

    $('#facebook_link').click(function(e){
      e.preventDefault();
      FB.getLoginStatus(function(response) {
        if (response.session) {
          // logged in and connected user, someone you know
          console.log('already logged in');
          console.log(response.session);
          postPhotoToFacebook();
        } else {
          // no user session available, someone you dont know
          console.log('not yet logged in');
          FB.login(function(response) {
            if (response.session) {
              console.log('logged in with session');
              console.log(response.session);
              if (response.perms) {
                console.log('and perms');
                console.log(response.perms);
                // user is logged in and granted some permissions.
                // perms is a comma separated list of granted permissions
                postPhotoToFacebook();
                } else {
                console.log('no perms');
                // user is logged in, but did not grant any permissions
              }
            } else {
              console.log('user failed to login');
              // user is not logged in
            }
          }, {perms:'publish_stream,user_photos'});


        }
      });
      
    })
  });
</script>

<div id='land_of_used_images' style="display:none;">

</div>
